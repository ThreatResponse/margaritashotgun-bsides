<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><title></title><meta name="generator" content="Hovercraft! 1.0 http://regebro.github.com/hovercraft"></meta><link rel="stylesheet" href="css/hovercraft.css" media="all"></link><link rel="stylesheet" href="css/impressConsole.css" media="all"></link><link rel="stylesheet" href="css/pygments/solarized-dark.css" media="all"></link><link rel="stylesheet" href="css/threatresponse.css" media="all"></link><link rel="stylesheet" href="css/print.css" media="all"></link><link rel="stylesheet" href="css/asciinema-player.css" media="all"></link><link rel="stylesheet" type="text/css" href="css/asciinema-player.css"></link><script src="js/asciinema-player.js"></script></head><body class="impress-not-supported"><div id="fixed-header" class="fixed-header"><img class="nav-icon" title="" alt="Threat Response Logo" src="static/tr_logo.png"></img><h1 class="nav-title">Threat Response - Margarita Shotgun</h1></div><div class="slides"><div id="impress"><div class="step step-level-1" step="0" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="0" data-y="0" data-z="0"><h1 id="margarita-shotgun">Margarita Shotgun</h1><h1 id="automating-memory-capture">Automating Memory Capture</h1><p>Joel Ferrier</p></div><div class="step step-level-1" step="1" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="1600" data-y="0" data-z="0"><h1 id="whoami">#whoami</h1><p>Joel Ferrier</p><p>SysAdmin</p><p>ThreatResponse Team Member</p></div><div class="step step-level-1" step="2" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="3200" data-y="0" data-z="0"><h1 id="important-things">Important Things</h1><ul><li>We are not a corporation</li><li>No one pays us to do this</li><li>Everything in this talk is FOSS</li></ul><h2 id="other-important-things">Other Important Things</h2><ul><li>All of us on the ThreatResponse Team have our day jobs.</li><li>These are my opinions not the opinions of my employer</li></ul></div><div class="step step-level-1" step="3" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="4800" data-y="0" data-z="0"><h1 id="agenda">Agenda</h1><h2 id="why-memory-capture">Why Memory Capture</h2><h2 id="memory-capture-tools">Memory Capture Tools</h2><h2 id="memory-capture-automation">Memory Capture Automation</h2></div><div class="step step-level-1" step="4" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="6400" data-y="0" data-z="0"><h1 id="id1">Why Memory Capture</h1><ul><li>Don't pull the plug</li><li>Scope of compromise unknown</li><li>Capture now, analyize later</li><li>Malware encrypted on disk</li><li>Malware non persistent on disk</li><li>State information</li></ul><div class="notes"><p>state information, current connections, process info</p></div></div><div class="step step-level-1" step="5" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="8000" data-y="0" data-z="0"><h1 id="tools-linux">Tools (Linux)</h1><h2 id="lime"><a href="https://github.com/504ensicsLabs/LiME">LiME</a></h2><ul><li>loadable kernel module</li><li>Multiple output mechanisms</li></ul><div class="notes"><p>LiME - Roots in android memory capture</p></div><div class="notes"><p>outputs, file, socket</p></div><h2 id="linpmem"><a href="http://www.rekall-forensic.com/docs/Tools/">LinPMem</a></h2><ul><li>Loadable kernel module</li><li>PMem family of tools</li><li>Rekall Project</li></ul></div><div class="step step-level-1" step="6" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="9600" data-y="0" data-z="0"><h1 id="using-lime-best-case">Using LiME (Best Case)</h1><ol><li>Connect to host</li><li>Identify Kernel Version, Distro, etc</li><li>Fetch pre-compiled LiME module</li><li>Load Kernel Module</li><li>Dump Memory</li></ol></div><div class="step step-level-1" step="7" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="11200" data-y="0" data-z="0"><h1 id="using-lime-worst-case">Using LiME (Worst Case)</h1><ol><li>Connect to host</li><li>Identify kernel version, distro, etc</li><li>Locate/install same distro, kernel version</li><li>Install gcc toolchain, kernel headers</li><li>Clone the LiME Repository</li><li>Compile LiME</li><li>Load Kernel Module</li><li>Dump Memory</li></ol></div><div class="step step-level-1" step="8" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="12800" data-y="0" data-z="0"><h1 id="best-case">Best Case</h1><ul><li>Steps performed by hand</li><li>External Dependencies</li></ul><div class="notes"><p>kernel modules - external depends</p></div><h1 id="worst-case">Worst Case</h1><ul><li>Each step performed by hand</li><li>External Dependencies</li><li>Development tools required</li><li>Slow</li></ul></div><div class="step step-level-1" step="9" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="14400" data-y="0" data-z="0"><h1 id="introducing-margarita-shotgun">Introducing Margarita Shotgun</h1></div><div class="step step-level-1" step="10" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="16000" data-y="0" data-z="0"><h1 id="id2">Margarita Shotgun</h1><ul><li>Python module</li><li>Compatible with Python 2 and 3</li><li>Install with pip</li><li>Automatic</li></ul><div class="notes"><p>quick installation
metadata collection
log of all actions taken agains instance</p></div></div><div class="step step-level-1" step="11" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="17600" data-y="0" data-z="0"><h1 id="goals">Goals</h1><ul><li>Support complex networks</li><li>Secure memory capture over the wire</li><li>Multiple storage backends</li><li>Capture memory in parallel</li></ul></div><div class="step step-level-1" step="12" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="19200" data-y="0" data-z="0"><h1 id="tech">Tech</h1><h2 id="paramiko">Paramiko</h2><h2 id="multiprocessing">Multiprocessing</h2><h2 id="s3-storage">S3 Storage</h2></div><div class="step step-level-1" step="13" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="20800" data-y="0" data-z="0"><h1 id="id3">Paramiko</h1><ul><li>Python SSH Client Library</li><li>Low Level client access</li><li>Nested SSH Transports</li><li>SSH Tunnel support</li></ul><div class="notes"><p>nest == jump hosts, direct tcp-ip connection
no shell outs with paramiko for tunnels, ssh command execution</p></div></div><div class="step step-level-1" step="14" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="22400" data-y="0" data-z="0"><h1 id="id4">Multiprocessing</h1><ul><li>GIL per process</li><li>Classically Parallel</li><li>Process Pool</li></ul><div class="notes"><p>I used the multiprocessing library to bypass a shortcoming of cpython,
for those of you who are not familiar with the Global Interpreter Lock
it is a Lock that prevents more than one thread from executing at a time.
If we create a process per memory capture we can use the resources of our
memory capture host more efficiently and complete captures faster</p></div></div><div class="step step-level-1" step="15" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="24000" data-y="0" data-z="0"><h1 id="s3-storage-backend">S3 Storage Backend</h1><h2 id="s3fs">s3fs</h2><ul><li>Write files directly to s3</li><li>Multipart upload</li><li>Zero local disk space required</li></ul></div><div class="step step-level-1" step="16" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="25600" data-y="0" data-z="0"><h1 id="what-about-the-kernel-modules">What About The Kernel Modules?</h1></div><div class="step step-level-1" step="17" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="27200" data-y="0" data-z="0"><h1 id="introducing-lime-compiler">Introducing lime-compiler</h1></div><div class="step step-level-1" step="18" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="28800" data-y="0" data-z="0"><h1 id="lime-compiler">Lime Compiler</h1><h2 id="ruby-gem">Ruby Gem</h2><h2 id="docker-integration">Docker Integration</h2><h2 id="supports-many-common-distros">Supports many common distros</h2><div class="notes"><p>gem listed in rubygems for next release, docker, use containers to install and build against kernel headers in official repositories</p></div></div><div class="step step-level-1" step="19" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="30400" data-y="0" data-z="0"><h1 id="why-build-ahead-of-time">Why Build Ahead Of Time?</h1><ul><li>Module compilation at run time is slow</li><li>External dependencies</li><li>Building against the comprimised host contaminates the instance</li></ul><div class="notes"><p>why compile ahead of time, instead of runtime?
building at run time assumes much about the responder's environment</p></div></div><div class="step step-level-1" step="20" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="32000" data-y="0" data-z="0"><h1 id="public-repository">Public Repository</h1><ul><li>Hosted in s3</li><li>Direct output from lime compiler</li><li><a href="https://threatresponse-lime-modules.s3.amazonaws.com/">Open to the world</a></li></ul><div class="notes"><p>we use lime-compiler to build kernel modules for a public repository
our repository is availible as a convinience, but you don't have to trust us, you can run your own
daily builds coming soon</p></div></div><div class="step step-level-1" step="21" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="33600" data-y="0" data-z="0"><h1 id="next-release">Next Release</h1><ul><li>Coming in a week or two</li><li>Repository Metadata</li><li>Module Signing</li></ul><div class="notes"><p>current implementation relies on s3 xml bucket listing
introduce metadata files, host in s3 or apache/nginx on prem</p></div></div><div class="step step-level-1" step="22" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="35200" data-y="0" data-z="0"><h1 id="caveats">Caveats</h1><h2 id="amazon-linux">Amazon Linux</h2><ul><li>No docker images</li><li>Special case for building modules</li></ul><div class="notes"><p>amazon linux doesn't have docker support
build against local server if you run on amazon linux</p></div></div><div class="step step-level-1" step="23" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="36800" data-y="0" data-z="0"><h1 id="id5">Margarita Shotgun</h1><h2 id="kernel-module-repository-disabled-by-default">Kernel Module Repository disabled by default</h2><h2 id="override-repository-with-your-own">Override repository with your own</h2><div class="notes"><p>margarita shotgun itegrates with the lime compiler repository
disabled by default, don't make requests unless you want to
override our repository, no need to trust us</p></div></div><div class="step step-level-1" step="24" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="38400" data-y="0" data-z="0"><h1 id="recap">Recap</h1><h2 id="id6">Using LiME (Worst Case)</h2><ol><li>Connect to host</li><li>Identify kernel version, distro, etc</li><li>Locate/install same distro</li><li>Install gcc toolchain, kernel headers</li><li>Clone the LiME Repository</li><li>Compile LiME</li><li>Load Kernel Module</li><li>Dump Memory</li></ol></div><div class="step step-level-1" step="25" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="40000" data-y="0" data-z="0"><h1 id="demo">Demo</h1><blockquote><div id="player-container" style="width: 100%;"></div>
<script>
    asciinema.player.js.CreatePlayer('player-container',
        'casts/marsho.json',
        {
            speed : 4,
        }
        );
</script></blockquote></div><div class="step step-level-1" step="26" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="41600" data-y="0" data-z="0"><h1 id="did-i-mention-it-s-a-library">Did I mention it's a library?</h1><pre class="highlight code python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">margaritashotgun</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">aws</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bucket</span> <span class="o">=</span> <span class="s1">'case-bucket'</span><span class="p">),</span>
<span class="o">...</span>               <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">dict</span><span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="s1">'10.10.12.10'</span><span class="p">,</span>
<span class="o">...</span>                              <span class="n">port</span> <span class="o">=</span> <span class="mi">22</span><span class="p">,</span>
<span class="o">...</span>                              <span class="n">username</span> <span class="o">=</span> <span class="s1">'ec2-user'</span><span class="p">,</span>
<span class="o">...</span>                              <span class="n">key</span> <span class="o">=</span> <span class="s1">'/path/to/private-key'</span><span class="p">)</span> <span class="p">]</span>
<span class="o">...</span>               <span class="n">workers</span> <span class="o">=</span> <span class="s1">'auto'</span><span class="p">,</span>
<span class="o">...</span>               <span class="n">logging</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">log_dir</span> <span class="o">=</span> <span class="s1">'logs/'</span><span class="p">,</span>
<span class="o">...</span>                              <span class="n">prefix</span> <span class="o">=</span> <span class="s1">'casenumber-10.10.12.10'</span><span class="p">),</span>
<span class="o">...</span>               <span class="n">repository</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">true</span><span class="p">,</span>
<span class="o">...</span>                                 <span class="n">url</span> <span class="o">=</span> <span class="s1">'repo.module-repo.io'</span><span class="p">))</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">capture_client</span> <span class="o">=</span> <span class="n">margaritashotgun</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'mem-capture'</span><span class="p">,</span>
<span class="o">...</span>                                          <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
<span class="o">...</span>                                          <span class="n">library</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="o">...</span>                                          <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="o">...</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">capture_client</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="p">{</span><span class="s1">'total'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">'failed'</span><span class="p">:[],</span><span class="s1">'completed'</span><span class="p">:[</span><span class="s1">'10.10.12.10'</span><span class="p">]}</span></pre></div><div class="step step-level-1" step="27" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="43200" data-y="0" data-z="0"><h1 id="future-work">Future Work</h1><h2 id="two-factor-authentication">Two Factor Authentication</h2><h2 id="delivery-methods">Delivery Methods</h2><ul><li>SSM</li></ul><h2 id="windows">Windows?</h2><div class="notes"><p>Open a github issue and let us know what you want</p></div></div><div class="step step-level-1" step="28" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="44800" data-y="0" data-z="0"><h1 id="thanks">Thanks</h1><blockquote><p>Andrew Krug @andrewkrug</p><p>Alex McCormack @amccormack</p><p>Jeff Parr @jparr</p><p>Kevin Hock @KevinHock2</p><p>Amazon Security</p></blockquote></div><div class="step step-level-1" step="29" data-rotate-x="0" data-rotate-y="0" data-rotate-z="0" data-scale="1" data-x="46400" data-y="0" data-z="0"><h1 id="joel-ferrier">Joel Ferrier</h1><h2 id="id8"><a href="https://github.com/ThreatResponse/margaritashotgun/">Margarita Shotgun</a></h2><p><a href="https://github.com/ThreatResponse/margaritashotgun">https://github.com/ThreatResponse/margaritashotgun</a></p><h2 id="id10"><a href="https://github.com/ThreatResponse/lime-compiler/">Lime Compiler</a></h2><p><a href="https://github.com/ThreatResponse/lime-compiler">https://github.com/ThreatResponse/lime-compiler</a></p><p>Check them out and contribute!</p></div></div></div><div id="hovercraft-help"><table><tr><th>Space</th><td>Forward</td></tr><tr><th>Right, Down, Page Down</th><td>Next slide</td></tr><tr><th>Left, Up, Page Up</th><td>Previous slide</td></tr><tr><th>P</th><td>Open presenter console</td></tr><tr><th>H</th><td>Toggle this help</td></tr></table></div><script type="text/javascript" src="js/impress.js"></script><script type="text/javascript" src="js/impressConsole.js"></script><script type="text/javascript" src="js/hovercraft.js"></script><script type="text/javascript" src="js/asciinema-player.js"></script></body></html>